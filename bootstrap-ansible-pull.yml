# bootstrap-ansible-pull.yml
- name: "Bootstrap Linux environment"
  hosts: localhost
  connection: local

  vars:
    common_packages:
      - git
      - curl
      - fish
      - lsd
      - bat
      - fzf
      - zoxide
      - duf
      - mc
      - entr
      - tealdeer
      - btop
      - micro
      - thefuck
      - figlet
      - cowsay
      - fortune-mod

    debian_packages:
      - 7zip
      - fonts-firacode
      - fortune-anarchism
      - anarchism

    fedora_packages:
      - 7zip
      - cascadia-code-nf-fonts
      - chezmoi

    arch_packages:
      - 7zip
      - ttf-firacode-nerd
      - chezmoi
      - base-devel
      - git

    arch_aur_packages:
      - fortune-mod-anarchism
      - anarchism

  tasks:
    - name: "Install ansible-core if not present"
      become: yes
      block:
        - name: "Install ansible-core (Debian)"
          ansible.builtin.apt:
            name: ansible-core
            state: present
            update_cache: yes
          when: ansible_os_family == "Debian"

        - name: "Install ansible-core (Fedora)"
          ansible.builtin.dnf:
            name: ansible-core
            state: present
          when: ansible_os_family == "RedHat"

        - name: "Install ansible-core (Arch)"
          ansible.builtin.pacman:
            name: ansible-core
            state: present
            update_cache: yes
          when: ansible_os_family == "Archlinux"

    - name: "Install required collections"
      ansible.builtin.command: >
        ansible-galaxy collection install community.general
      args:
        creates: "{{ ansible_env.HOME }}/.ansible/collections/ansible_collections/community/general"

    # --- Package Installation ---
    - name: "Install packages (Debian/Ubuntu)"
      become: yes
      ansible.builtin.apt:
        name: "{{ item }}"
        state: present
      loop: "{{ common_packages + debian_packages }}"
      when: ansible_os_family == "Debian"

    - name: "Install packages (Fedora)"
      become: yes
      ansible.builtin.dnf:
        name: "{{ item }}"
        state: present
      loop: "{{ common_packages + fedora_packages }}"
      when: ansible_os_family == "RedHat"

    - name: "Install official packages (Arch)"
      become: yes
      ansible.builtin.pacman:
        name: "{{ item }}"
        state: present
      loop: "{{ common_packages + arch_packages }}"
      when: ansible_os_family == "Archlinux"

    # --- Simple AUR Installation ---
    - name: "Install yay if missing"
      when: ansible_os_family == "Archlinux"
      become: yes
      become_user: "{{ ansible_user_id }}"
      ansible.builtin.shell:
        cmd: |
          if ! command -v yay >/dev/null; then
            sudo pacman -S --noconfirm --needed git base-devel
            cd /tmp
            git clone https://aur.archlinux.org/yay.git
            cd yay
            makepkg -si --noconfirm
          fi
      environment:
        HOME: "/home/{{ ansible_user_id }}"
    
    - name: "Install AUR packages individually as current user"
      when: ansible_os_family == "Archlinux"
      # Notice: no 'become: yes' here
      ansible.builtin.shell:
        cmd: "yay -S --noconfirm --needed {{ item }}"
      loop: "{{ arch_aur_packages }}"
      environment:
        HOME: "/home/{{ ansible_user_id }}"

    # --- Post-installation fixes ---
    - name: "Link batcat to bat on Debian systems"
      become: yes
      ansible.builtin.file:
        src: /usr/bin/batcat
        dest: /usr/local/bin/bat
        state: link
      when: ansible_os_family == "Debian"

    - name: "Install Chezmoi via official script"
      become: yes
      ansible.builtin.shell: |
        sh -c "$(curl -fsLS get.chezmoi.io)" -- -b /usr/local/bin
      args:
        creates: /usr/local/bin/chezmoi
      when: ansible_os_family != "Archlinux"
